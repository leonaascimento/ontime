<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:include="shared/layout :: layout">

<head>
</head>

<body>
	<div th:fragment="content">
		<table class="table">
			<thead>
				<tr>
					<th>Conte&uacute;do</th>
				</tr>
			</thead>
			<th:block th:each="comment : ${comments}">
				<tr>
					<td th:text="${comment.content}"></td>
				</tr>
			</th:block>
		</table>
		<form th:action="@{/projects/{projectId}/tasks/{taskId}/comments/create(projectId=${projectId},taskId=${taskId})}" method="POST">
			<div class="form-group">
				<div class="col-md-12">
					<textarea rows="5" class="form-control" id="content" name="content" placeholder="Coment&aacute;rio"></textarea>
					<span class="help-block" id="content-help"></span>
				</div>
			</div>
			<div class="form-group">
				<div class="col-md-10 col-md-offset-2">
					<button type="submit" class="btn btn-primary">Enviar</button>
				</div>
			</div>
		</form>
	</div>
	<script type="text/javascript" th:fragment="script">
		var pusher = new Pusher('1903bfdf2d61093ea14d');
		var channel = pusher.subscribe('comments-channel');

		channel.bind('new_comment', function(data) {
			$('.table > tbody:last-child').append('<tr><td>' + data.content + '</td></tr>');
		});
		
		// process the form
	    $('form').submit(function(event) {
	    	
	    	
	        // get the form data
	        // there are many ways to get this data using jQuery (you can use the class or id also)
	        var formData = $(this).serializeArray();
	        var formURL = $(this).attr("action");
	        
	        console.log(formData);
	        console.log(formURL);
	        
	        // process the form
	        $.ajax({
	            type        : 'POST', // define the type of HTTP verb we want to use (POST for our form)
	            url         : formURL, // the url where we want to POST
	            data        : formData, // our data object
	            dataType    : 'json', // what type of data do we expect back from the server
	                        encode          : true
	        })
	            // using the done promise callback
	            .done(function(data) {

	                // log data to the console so we can see
	                console.log(data); 
	                $('#content').val('');

	                // here we will handle errors and validation messages
	            });

	        // stop the form from submitting the normal way and refreshing the page
	        event.preventDefault();
	    });
	</script>
</body>

</html>